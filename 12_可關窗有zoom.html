<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCd2fFmHB7xWd3E_Y3DWuVgomIqiclUkNE&callback=initMap&callback=initMap&libraries=&v=weekly"
        defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"
        integrity="sha384-q2kxQ16AaE6UbzuKqyBE9/u/KzioAlnx2maXQHiDX9d4/zp8Ok3f+M7DPm+Ib6IU" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.min.js"
        integrity="sha384-pQQkAEnwaBkjpqZ8RU1fF1AKtTcHJwFl3pblpTlHXybJjHpMYo79HY3hIi4NKxyj" crossorigin="anonymous">
    </script>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        #map {
            width: 100%;
            height: 100%;
            /* display: flex; */
            /* position: absolute; */
            /* right: 0; */
        }

        html,
        body {
            height: 100%;
        }

        .dropdown-toggle::after {
            content: none;
        }

        .dropdown-menu-town {
            /* background-color: rgb(169, 189, 189); */
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            /* border: 1px solid rgb(116, 114, 114); */
        }

        .dropdown-menu-townitem {
            width: 100%;
            text-decoration: none;
            color: #fff;
            padding: 0 1vw;
            cursor: pointer;
            /* background-color: aqua; */
        }

        @media screen and (min-width: 992px) {
            .navbar-collapse {
                width: fit-content;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <!-- <div class="container-fluid"> -->
                <a class="navbar-brand" href="#">台灣景點圖 Taiwan Attractions Map</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavDarkDropdown" aria-controls="navbarNavDarkDropdown" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDarkDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                北部 North
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                                <li><a class="dropdown-item taipei" href="#" data-control="臺北市">臺北市 Taipei City</a></li>
                                <li><a class="dropdown-item" href="#" data-control="新北市">新北市 New Taipei City</a></li>
                                <li><a class="dropdown-item" href="#" data-control="基隆市">基隆市 Keelung City</a></li>
                                <li><a class="dropdown-item" href="#" data-control="桃園市">桃園市 Taoyuan City</a></li>
                                <li><a class="dropdown-item" href="#" data-control="新竹市">新竹市 Hsinchu City</a></li>
                                <li><a class="dropdown-item" href="#" data-control="新竹縣">新竹縣 Hsinchu County</a></li>
                                <li><a class="dropdown-item" href="#" data-control="宜蘭縣">宜蘭縣 Yilan County</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                中部 Central
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                                <li><a class="dropdown-item" href="#" data-control="苗栗縣">苗栗縣 Miaoli County</a></li>
                                <li><a class="dropdown-item" href="#" data-control="臺中市">臺中市 Taichung City</a></li>
                                <li><a class="dropdown-item" href="#" data-control="彰化縣">彰化縣 Changhua County</a></li>
                                <li><a class="dropdown-item" href="#" data-control="南投縣">南投縣 Nantou County</a></li>
                                <li><a class="dropdown-item" href="#" data-control="雲林縣">雲林縣 Yunlin County</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                南部 South
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                                <li><a class="dropdown-item" href="#" data-control="嘉義市">嘉義市 Chiayi City</a></li>
                                <li><a class="dropdown-item" href="#" data-control="嘉義縣">嘉義縣 Chiayi County</a></li>
                                <li><a class="dropdown-item" href="#" data-control="臺南市">臺南市 Tainan City</a></li>
                                <li><a class="dropdown-item" href="#" data-control="高雄市">高雄市 Kaohsiung City</a></li>
                                <li><a class="dropdown-item" href="#" data-control="屏東縣">屏東縣 Pingtung County</a></li>
                                <li><a class="dropdown-item" href="#" data-control="澎湖縣">澎湖縣 Penghu County</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                東部 East
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                                <li><a class="dropdown-item" href="#" data-control="花蓮縣">花蓮縣 Hualien County</a></li>
                                <li><a class="dropdown-item" href="#" data-control="臺東縣">臺東縣 Taitung County</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                金馬 Kinmen-Mazu
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                                <li><a class="dropdown-item" href="#" data-control="金門縣">金門縣 Kinmen County</a></li>
                                <li><a class="dropdown-item" href="#" data-control="連江縣">連江縣 Lienchiang County</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="container-fluid">
                    <div class="row town">
                        <div class="dropdown-menu-town">
                            <!--注意這裡目前是 div 可以考慮，改成ul?-->
                            <!-- <li><a class="dropdown-menu-townitem" href="#">恆春鎮</a></li> -->
                        </div>
                    </div>
                </div>
                <!-- </div> -->
            </nav>
        </div>
    </div>

    <div id="map"></div>

    <script>
        window.onload = (function () {
            getData();
        });

        let jsonData;
        let myNewArray = [];
        // let zIndex = 0;
        var infoWindow;
        var map;
        // var lastinfowindow;
        // var myMarker;

        const cors = 'https://cors-anywhere.herokuapp.com/'; // use cors-anywhere to fetch api data
        const url = "https://cors-anywhere.herokuapp.com/https://bsopendata.azurewebsites.net/api/LeisureTravel/Attractions"; // origin api url

        function getData() {
            fetch("https://raw.githubusercontent.com/linooohon/googlemap/main/%E6%99%AF%E9%BB%9E.json", {
                    // headers: new Headers({
                    //     'Content-Type': 'application/json'
                    // }),
                })
                .then((response) => {
                    console.log(response);
                    return response.json();
                })
                .then((jsonData) => {
                    transForm(jsonData);
                })
                .catch((err) => {
                    console.log("錯誤:", err);
                });
        }

        function transForm(jsonObj) {
            let target = jsonObj.XML_Head.Infos.Info;
            target.forEach((item) => {
                //zIndex = zIndex + 1;
                myNewObj = {
                    id: item.Id,
                    name: item.Name,
                    description: item.Description,
                    tel: item.Tel,
                    address: item.Add,
                    region: item.Region,
                    town: item.Town,
                    px: item.Px,
                    py: item.Py,
                    //zindex: zIndex
                }
                myNewArray.push(myNewObj)
            });
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 8,
                center: new google.maps.LatLng(23.8398335, 120.4220497),
            });

            infoWindow = new google.maps.InfoWindow();

            map.addListener('click', function () {
                if (infoWindow) infoWindow.close();
            });
        }

        //--------------------------------------------

        //點擊北中南東離島綁事件跑showRegionMarker - 綁父層 - 取得子層縣市處理
        document.querySelector(".navbar-nav").addEventListener("click", showRegionMarker);

        //顯示出對應縣市的marker
        let regionMarkers = [];

        function showRegionMarker(e) {
            e.preventDefault(); //阻止a連結預設的跳轉網頁練習用
            regionMarkers.forEach((marker) => marker.setMap(null)); //消除前次縣市marker
            townMarkers.forEach((marker) => marker.setMap(null)); //消除前次鄉鎮區marker
            myNewArray.forEach((element) => {
                if (element.region == e.target.dataset.control) {

                    addMarker({
                        coords: {
                            lat: element.py,
                            lng: element.px
                        },
                        content: `<div class="content">${element.name}</div>`
                    });

                    map.setCenter({
                        lat: element.py,
                        lng: element.px
                    });
                    map.setZoom(11);
                }
            });
        }
        // ----------------------------

        //點擊縣市綁事件跑countTownFunc - 綁父層 - 取得子層縣市處理
        document.querySelector(".navbar-nav").addEventListener("click", countTownFunc);

        //顯示出縣市對應的鄉鎮區
        let countTown = [];
        let townDiv = document.querySelector(".dropdown-menu-town");

        function countTownFunc(e) {
            e.preventDefault();
            townDiv.innerHTML = "";
            countTown = [];
            myNewArray.forEach((element) => {
                if (element.region == e.target.dataset.control) {
                    countTown.push(element.town);
                }
            });
            //console.log(countTown);

            let result = countTown.sort().reduce((init, current) => {
                if (init.length === 0 || init[init.length - 1] !== current) {
                    init.push(current);
                }
                return init;
            }, []);
            //console.log(result);

            result.forEach((item) => {
                let li = document.createElement("li");
                let a = document.createElement("a");
                a.innerText = item;
                a.classList.add("dropdown-menu-townitem");
                li.setAttribute("data-region", e.target.dataset.control);
                li.setAttribute("class", "region-name");
                li.appendChild(a);
                townDiv.style.border = "1px solid rgb(116, 114, 114)";
                townDiv.appendChild(li);
            });
        }


        //--------------------------------


        //點擊縣市ul 綁父層跑showTownMarker - 取得子li處理
        document.querySelector(".dropdown-menu-town").addEventListener("click", showTownMarker);

        //顯示對應鄉鎮區marker
        let townMarkers = [];

        function showTownMarker(e) {
            let li = document.querySelector(".region-name");
            e.preventDefault(); //阻止a連結預設的跳轉網頁練習用
            regionMarkers.forEach((marker) => marker.setMap(null)); //消除前次縣市 marker
            townMarkers.forEach((marker) => marker.setMap(null)); //消除前次鄉鎮區 marker
            myNewArray.forEach((element) => {
                if (element.region == li.dataset.region &&
                    element.town == e.target.innerText) {

                    addMarker({
                        coords: {
                            lat: element.py,
                            lng: element.px
                        },
                        content: `<div class="content">${element.name}</div>`
                    });

                    map.setCenter({
                        lat: element.py,
                        lng: element.px
                    });
                    map.setZoom(12);
                }
            });
        }


        //--------------------------------------------------------




        function addMarker(props) {
            var marker = new google.maps.Marker({
                position: props.coords,
                map: map
            });

            regionMarkers.push(marker);
            townMarkers.push(marker);

            if (props.content) {
                marker.addListener('click', function () {
                    infoWindow.setContent(props.content);
                    infoWindow.open(map, marker);
                });
            }
        }
    </script>
</body>

</html>